# Connection Pool
![alt text](image-3.png)
## Má»¥c tiÃªu
Thiáº¿t láº­p connection pool Ä‘á»ƒ Ä‘áº£m báº£o táº­n dá»¥ng tÃ i nguyÃªn há»‡ thá»‘ng hiá»‡u quáº£

## TrÆ°á»ng há»£p khÃ´ng sá»­ dá»¥ng connection pool
Má»—i khi client cÃ³ yÃªu cáº§u káº¿t ná»‘i, server sáº½ lÃ m nhá»¯ng Ä‘iá»u sau:
- Thiáº¿t láº­p káº¿t ná»‘i.
- Giáº£i phÃ³ng káº¿t ná»‘i.

=> Äiá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n nhá»¯ng Ä‘iá»u sau:
- **Chá» Ä‘á»£i lÃ¢u:** Client sáº½ chá» Ä‘á»£i thiáº¿t láº­p cÆ¡ sá»Ÿ dá»¯ liá»‡u.
- **LÃ£ng phÃ­ tÃ i nguyÃªn:** Server sáº½ máº¥t cÃ´ng sá»©c thiáº¿t láº­p/giáº£i phÃ³ng káº¿t ná»‘i thay vÃ¬ táº­p trung xá»­ lÃ½ cÃ¡c thao tÃ¡c nghiá»‡p vá»¥.
- **Hiá»‡u suáº¥t kÃ©m:** Server cÃ³ thá»ƒ bá»‹ quÃ¡ táº£i trong thá»i Ä‘iá»ƒm táº£i cao.

## LÃ½ do sá»­ dá»¥ng
### Æ¯u Ä‘iá»ƒm
- **Giáº£m Ä‘á»™ trá»…:** Loáº¡i bá» thá»i gian cháº¿t Ä‘á»ƒ thiáº¿t láº­p káº¿t ná»‘i má»›i cho má»—i yÃªu cáº§u. á»¨ng dá»¥ng cÃ³ thá»ƒ truy cáº­p database gáº§n nhÆ° tá»©c thá»i.âœ…
- **TÄƒng hiá»‡u suáº¥t:** TÃ¡i sá»­ dá»¥ng káº¿t ná»‘i giÃºp giáº£m táº£i cho database server, tÄƒng kháº£ nÄƒng xá»­ lÃ½ Ä‘á»“ng thá»i vÃ  duy trÃ¬ hiá»‡u suáº¥t cao, Ä‘áº·c biá»‡t trong cÃ¡c á»©ng dá»¥ng cÃ³ lÆ°á»£ng truy cáº­p lá»›n.âœ…
- **Tiáº¿t kiá»‡m tÃ i nguyÃªn:** Giáº£m thiá»ƒu chi phÃ­ khá»Ÿi táº¡o vÃ  giáº£i phÃ³ng káº¿t ná»‘i, giÃºp tá»‘i Æ°u hÃ³a viá»‡c sá»­ dá»¥ng tÃ i nguyÃªn há»‡ thá»‘ng.âœ…
- **Quáº£n lÃ½ káº¿t ná»‘i hiá»‡u quáº£:** Connection Pool cung cáº¥p cÆ¡ cháº¿ quáº£n lÃ½ táº­p trung cÃ¡c káº¿t ná»‘i, giÃºp dá»… dÃ ng theo dÃµi, giÃ¡m sÃ¡t vÃ  cáº¥u hÃ¬nh sá»‘ lÆ°á»£ng káº¿t ná»‘i, thá»i gian timeout, ...âœ…
### NhÆ°á»£c Ä‘iá»ƒm
CÃ³ thá»ƒ cáº§n quan tÃ¢m Ä‘áº¿n cÃ¡c váº¥n Ä‘á»
- Sá»‘ lÆ°á»£ng káº¿t ná»‘i lÃ  bao nhiÃªu Ä‘á»ƒ khÃ´ng chiáº¿m dá»¥ng tÃ i nguyÃªn há»‡ thá»‘ng hoáº·c client khÃ´ng pháº£i Ä‘á»£i lÃ¢u?
- Quáº£n lÃ½ cáº¥u hÃ¬nh tháº¿ nÃ o?
- CÃ³ bá»‹ dÃ¹ng kÃ© káº¿t ná»‘i mÃ  khÃ´ng truy cáº­p tÃ i nguyÃªn khÃ´ng? (Connection Leak)

## CÃ¡ch triá»ƒn khai
Muá»‘n triá»ƒn khai connection pool chá»‰ cáº§n 3 bÆ°á»›c:
1. PhÃ¢n tÃ­ch chuá»—i káº¿t ná»‘i DB Ä‘á»ƒ khá»Ÿi táº¡o config
2. Thiáº¿t láº­p cáº¥u hÃ¬nh cho pool
3. Khá»Ÿi táº¡o pool vá»›i cáº¥u hÃ¬nh Ä‘Ã£ Ä‘á»‹nh nghÄ©a
4. Khi káº¿t thÃºc, Close() pool Ä‘á»ƒ thu há»“i toÃ n bá»™ káº¿t ná»‘i.

## Code máº«u
```go
poolConfig, err := pgxpool.ParseConfig(config.DBSource)
	if err != nil {
		log.Fatal("cannot parse pool config:", err)
	}

	/*
  Logger setup
  */

	poolConfig.MaxConns = 20
	poolConfig.MinConns = 5
	poolConfig.MaxConnLifetime = 30 * time.Minute
	poolConfig.HealthCheckPeriod = 1 * time.Minute

	connPool, err := pgxpool.NewWithConfig(ctx, poolConfig)
	if err != nil {
		log.Fatal("cannot connect to database: ", err)
	}

	defer connPool.Close()
```
Äá»ƒ giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» Ä‘Ã£ nÃªu ra á»Ÿ pháº§n nhÆ°á»£c Ä‘iá»ƒm, tÃ´i Ã¡p dá»¥ng cÃ¡c biá»‡n phÃ¡p sau:
1. Sá»‘ lÆ°á»£ng káº¿t ná»‘i bao nhiÃªu lÃ  há»£p lÃ½?
- ğŸ‘‰ CÃ¡ch tÃ­nh gáº§n Ä‘Ãºng:
```
MaxConns = (CPU_Core * 2) + (Worker_Buffer)
```
Trong Ä‘Ã³:
- CPU_Core lÃ  sá»‘ core cá»§a CPU
- Worker_Buffer lÃ  sá»‘ lÆ°á»£ng káº¿t ná»‘i dá»± phÃ²ng cho cÃ¡c goroutine cÃ³ thá»ƒ bá»‹ block. Tuá»³ theo há»‡ thá»‘ng cÃ³ thá»ƒ láº¥y gÃ­a trá»‹ nhÆ° sau:
	- á»¨ng dá»¥ng nhá» dev/test: 2-5
	- Web app trung bÃ¬nh: 5-15
	- Nhiá»u goroutine/blocking I/O: 10-30

Do hiá»‡n táº¡i Ä‘Ã¢y lÃ  á»©ng dá»¥ng Web app trung bÃ¬nh vÃ  sá»‘ CPU_Core cá»§a mÃ¡y host Ä‘ang lÃ  4 nÃªn sá»‘ káº¿t ná»‘i sáº½ thiáº¿t láº­p lÃ : `MaxConns = (4 * 2) + 12 = 20`

- ğŸ‘‰ CÃ¡ch thá»±c nghiá»‡m:
	- Äo thá»i gian pháº£n há»“i khi `MaxConns = 10, 20, 30....`.
	- Kiá»ƒm tra `pg_stat_activity` Ä‘á»ƒ xem káº¿t ná»‘i nÃ o Ä‘ang má»Ÿ.
	- DÃ¹ng `connPool.Stat()` Ä‘á»ƒ xem sá»‘ lÆ°á»£ng káº¿t ná»‘i Ä‘Æ°á»£c dÃ¹ng thá»±c táº¿

	VD:
	- Theo dÃµi `pg_stat_activity` Ä‘á»ƒ Ä‘iá»u chá»‰nh:
	![alt text](image-4.png)
	- Theo dÃµi log á»Ÿ á»©ng dá»¥ng thÃ´ng qua `connPool.Stat()` Ä‘á»ƒ Ä‘Æ°a ra Ä‘iá»u chá»‰nh
	```go
	stat := connPool.Stat()
	fmt.Printf("Total: %d | Acquired: %d | Idle:%d | InUse: %d\n", stat.TotalConns(), stat.AcquiredConns(), stat.IdleConns(), stat.ConnsInUse())
	```
2. Quáº£n lÃ½ cáº¥u hÃ¬nh tháº¿ nÃ o?
- DÃ¹ng biáº¿n mÃ´i trÆ°á»ng lÃ  xong

3. CÃ³ bá»‹ dÃ¹ng kÃ© káº¿t ná»‘i mÃ  khÃ´ng truy cáº­p tÃ i nguyÃªn khÃ´ng? (Connection Leak)
- LuÃ´n `defer rows.Close()` vÃ  `defer tx.Rollback()` náº¿u cÃ³ lá»—i.
- Kiá»ƒm tra báº±ng `connPool.Stat()`.
